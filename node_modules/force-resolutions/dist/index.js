#!/usr/bin/env node

"use strict";var e=require("fs");function n(e,n,i,r){return new(i||(i=Promise))((function(o,t){function s(e){try{d(r.next(e))}catch(e){t(e)}}function c(e){try{d(r.throw(e))}catch(e){t(e)}}function d(e){var n;e.done?o(e.value):(n=e.value,n instanceof i?n:new i((function(e){e(n)}))).then(s,c)}d((r=r.apply(e,n||[])).next())}))}const i=i=>n(void 0,void 0,void 0,(function*(){try{return yield e.promises.access(i,e.constants.O_RDWR),!0}catch(e){return!1}}));let r,o,t,s,c=!0;"undefined"!=typeof process&&(({FORCE_COLOR:r,NODE_DISABLE_COLORS:o,NO_COLOR:t,TERM:s}=process.env),c=process.stdout&&process.stdout.isTTY);const d={enabled:!o&&null==t&&"dumb"!==s&&(null!=r&&"0"!==r||c),reset:a(0,0),bold:a(1,22),dim:a(2,22),italic:a(3,23),underline:a(4,24),inverse:a(7,27),hidden:a(8,28),strikethrough:a(9,29),black:a(30,39),red:a(31,39),green:a(32,39),yellow:a(33,39),blue:a(34,39),magenta:a(35,39),cyan:a(36,39),white:a(37,39),gray:a(90,39),grey:a(90,39),bgBlack:a(40,49),bgRed:a(41,49),bgGreen:a(42,49),bgYellow:a(43,49),bgBlue:a(44,49),bgMagenta:a(45,49),bgCyan:a(46,49),bgWhite:a(47,49)};function l(e,n){let i,r=0,o="",t="";for(;r<e.length;r++)i=e[r],o+=i.open,t+=i.close,~n.indexOf(i.close)&&(n=n.replace(i.rgx,i.close+i.open));return o+n+t}function a(e,n){let i={open:`[${e}m`,close:`[${n}m`,rgx:new RegExp(`\\x1b\\[${n}m`,"g")};return function(n){return void 0!==this&&void 0!==this.has?(~this.has.indexOf(e)||(this.has.push(e),this.keys.push(i)),void 0===n?this:d.enabled?l(this.keys,n+""):n+""):void 0===n?function(e,n){let i={has:e,keys:n};return i.reset=d.reset.bind(i),i.bold=d.bold.bind(i),i.dim=d.dim.bind(i),i.italic=d.italic.bind(i),i.underline=d.underline.bind(i),i.inverse=d.inverse.bind(i),i.hidden=d.hidden.bind(i),i.strikethrough=d.strikethrough.bind(i),i.black=d.black.bind(i),i.red=d.red.bind(i),i.green=d.green.bind(i),i.yellow=d.yellow.bind(i),i.blue=d.blue.bind(i),i.magenta=d.magenta.bind(i),i.cyan=d.cyan.bind(i),i.white=d.white.bind(i),i.gray=d.gray.bind(i),i.grey=d.grey.bind(i),i.bgBlack=d.bgBlack.bind(i),i.bgRed=d.bgRed.bind(i),i.bgGreen=d.bgGreen.bind(i),i.bgYellow=d.bgYellow.bind(i),i.bgBlue=d.bgBlue.bind(i),i.bgMagenta=d.bgMagenta.bind(i),i.bgCyan=d.bgCyan.bind(i),i.bgWhite=d.bgWhite.bind(i),i}([e],[i]):d.enabled?l([i],n+""):n+""}}(function(){return n(this,void 0,void 0,(function*(){try{const n="win32"===process.platform,r=process.cwd(),o=n?"\\":"/",t=`${r}${o}package-lock.json`,s=`${r}${o}package.json`,c=yield i(t),l=yield i(s);if(c&&l){const n=yield e.promises.readFile(s),i=yield e.promises.readFile(t);let r=JSON.parse(n.toString()),o=JSON.parse(i.toString());const c=r.resolutions;console.log(d.cyan("Applying forced resolutions")),c&&(Object.keys(c).forEach((e=>{const n=((e,n)=>{const i=[],r=[],o=[];if(!e&&("object"!=typeof e||Array.isArray(e)))throw new TypeError("First argument of finPropPath is not the correct type Object");if("function"!=typeof n)throw new TypeError("Predicate is not a function");const t=e=>{Object.keys(e).forEach((s=>{!0===n(s,r,e)&&(r.push(s),o.push(r.join(".")),r.pop());const c=e[s];c&&"object"==typeof c&&!Array.isArray(c)&&(i.find((e=>e===c))||(r.push(s),i.push(c),t(c),r.pop()))}))};return t(e),o})(o,(n=>n===e));let i={};n.forEach((n=>{const r=/packages./g,o=/.requires./g;if(!n.match(/.dependencies./g)||n.match(o)||n.match(r)){if(n.match(r))i[n]=c[e];else if(n.match(o)){i[n]=c[e];const r=n.replace("requires","dependencies");i[`${r}.version`]=c[e],i[`${r}.resolved`]=void 0,i[`${r}.integrity`]=void 0,i[`${r}.requires`]=void 0}}else i[`${n}.version`]=c[e],i[`${n}.resolved`]=void 0,i[`${n}.integrity`]=void 0,i[`${n}.requires`]=void 0})),o=((e,n)=>(Object.keys(n).forEach((i=>{let r=e,o=i.split("."),t=o.pop();o.forEach((e=>(r[e]=r[e]||{})&&(r=r[e]))),t&&(r[t]=n[i])})),e))(o,i),i={},console.log(d.dim(`${e} => ${c[e]}`))})),yield e.promises.writeFile(t,JSON.stringify(o,null,2)),console.log(d.green("Finished applying forced resolutions")))}}catch(e){console.log(d.red("An unexpected error has occurred while running force-resolutions")),console.error(e)}}))})().then();
